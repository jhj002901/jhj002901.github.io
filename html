<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LIFE-MOGOTCHI Â· Zodiac Tamagotchi</title>
  <style>
    :root{
      --bg:#0b0c10;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.09);
      --stroke:rgba(255,255,255,.14);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.65);
      --good:#9be7c4;
      --ok:#ffe7a6;
      --bad:#ffb3b3;
      --accent:#b6a6ff;
      --radius:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.38);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:
        radial-gradient(900px 600px at 25% 10%, rgba(182,166,255,.18), transparent 60%),
        radial-gradient(800px 520px at 80% 25%, rgba(155,231,196,.14), transparent 60%),
        var(--bg);
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Apple SD Gothic Neo", "Noto Sans KR", Arial;
      padding:18px;
    }

    /* Tamagotchi device */
    .device{
      width:min(920px, 96vw);
      border-radius:30px;
      padding:18px;
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .device::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 220px at 20% 0%, rgba(255,255,255,.12), transparent 60%),
        radial-gradient(500px 200px at 85% 15%, rgba(182,166,255,.18), transparent 60%),
        radial-gradient(600px 280px at 60% 110%, rgba(155,231,196,.10), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .device-inner{position:relative; z-index:1}

    .topbar{
      display:flex;
      gap:12px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:6px 6px 12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand .title{
      font-size:15px;
      font-weight:750;
      letter-spacing:.4px;
    }
    .brand .subtitle{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }

    .top-actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(0,0,0,.14);
      font-size:12px;
      color:var(--muted);
    }
    .pill strong{color:var(--text); font-weight:650}
    .btn{
      cursor:pointer;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.08);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-size:12px;
      transition:transform .12s, background .12s, border-color .12s;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.12)}
    .btn:active{transform:translateY(0)}
    .btn.primary{border-color:rgba(182,166,255,.5); background:rgba(182,166,255,.18)}
    .btn.danger{border-color:rgba(255,179,179,.5); background:rgba(255,179,179,.10)}

    /* Screen area */
    .screen-shell{
      border-radius:26px;
      padding:16px;
      background:rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.14);
    }
    .screen{
      border-radius:20px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.16);
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.12));
      position:relative;
      height: 420px;
    }
    @media (max-width:720px){
      .screen{height: 440px;}
    }

    /* HUD inside screen */
    .hud{
      position:absolute;
      top:10px; left:10px; right:10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      pointer-events:none;
    }
    .hud-left, .hud-right{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .hud-badge{
      pointer-events:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.18);
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(6px);
    }
    .hud-badge strong{color:var(--text); font-weight:700}
    .bar{
      width:120px;
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      overflow:hidden;
    }
    .bar > i{
      display:block;
      height:100%;
      width:50%;
      background:rgba(155,231,196,.85);
    }
    .bar.warn > i{ background:rgba(255,231,166,.85); }
    .bar.bad > i{ background:rgba(255,179,179,.85); }

    /* Floor + background decorations */
    .bg{
      position:absolute; inset:0;
      pointer-events:none;
    }
    .floor{
      position:absolute;
      left:0; right:0; bottom:0;
      height:140px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.26));
      border-top:1px solid rgba(255,255,255,.10);
    }
    .room-items{
      position:absolute;
      bottom:18px; left:14px; right:14px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      opacity:.95;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.28));
    }
    .item{
      width:120px;
      height:70px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      color:rgba(255,255,255,.75);
      font-size:28px;
      backdrop-filter: blur(6px);
    }
    @media (max-width:520px){
      .item{width:92px; height:64px; font-size:26px;}
    }

    /* Character */
    .character{
      position:absolute;
      width:120px;
      height:120px;
      left:50%;
      top: 52%;
      transform: translate(-50%, -50%);
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      filter: drop-shadow(0 18px 28px rgba(0,0,0,.35));
    }
    .sprite{
      width:108px;
      height:108px;
      border-radius:34px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.07);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:64px;
      position:relative;
      backdrop-filter: blur(8px);
    }
    .sprite::after{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:26px;
      border:1px solid rgba(255,255,255,.08);
      opacity:.8;
      pointer-events:none;
    }
    .nameplate{
      position:absolute;
      bottom:-26px;
      left:50%;
      transform:translateX(-50%);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.20);
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      backdrop-filter: blur(6px);
    }

    /* speech bubble */
    .bubble{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      top:-54px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.22);
      font-size:12px;
      color:rgba(255,255,255,.86);
      max-width:280px;
      text-align:center;
      opacity:0;
      transition:opacity .18s, transform .18s;
      pointer-events:none;
      backdrop-filter: blur(8px);
    }
    .bubble.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }
    .bubble::after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-7px;
      transform:translateX(-50%);
      width:12px;
      height:12px;
      background:rgba(0,0,0,.22);
      border-right:1px solid rgba(255,255,255,.14);
      border-bottom:1px solid rgba(255,255,255,.14);
      transform:translateX(-50%) rotate(45deg);
    }

    /* Bottom controls (tamagotchi buttons) */
    .controls{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      padding:14px 8px 0;
    }
    .ctrl-left,.ctrl-right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .hint{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.10);
    }

    /* Modal for zodiac selection */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:999;
    }
    .modal-backdrop.show{display:flex;}
    .modal{
      width:min(860px, 96vw);
      border-radius:22px;
      border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.18));
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      padding:16px;
      position:relative;
    }
    .modal h3{margin:6px 6px 10px; font-size:14px; letter-spacing:.3px}
    .modal p{margin:0 6px 12px; color:var(--muted); font-size:12px; line-height:1.4}
    .zodiac-grid{
      display:grid;
      grid-template-columns: repeat(6, 1fr);
      gap:10px;
      padding:6px;
    }
    @media (max-width:740px){ .zodiac-grid{grid-template-columns: repeat(4, 1fr);} }
    @media (max-width:520px){ .zodiac-grid{grid-template-columns: repeat(3, 1fr);} }
    .zodiac{
      cursor:pointer;
      padding:12px 10px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:8px;
      transition:transform .12s, background .12s, border-color .12s;
      user-select:none;
    }
    .zodiac:hover{transform:translateY(-2px); background:rgba(255,255,255,.10)}
    .zodiac:active{transform:translateY(0)}
    .zodiac .e{font-size:34px}
    .zodiac .t{font-size:12px; color:rgba(255,255,255,.86)}
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      padding:10px 6px 4px;
      flex-wrap:wrap;
    }

    /* subtle pixel-ish vibe */
    .pixel{
      image-rendering: pixelated;
    }
  </style>
</head>
<body>
  <div class="device">
    <div class="device-inner">
      <div class="topbar">
        <div class="brand">
          <div class="title">LIFE-MOGOTCHI (í˜„ì‹¤ ì—°ë™ ë‹¤ë§ˆê³ ì¹˜)</div>
          <div class="subtitle">ë°©í–¥í‚¤/WSADë¡œ ì´ë™ Â· ë²„íŠ¼ìœ¼ë¡œ ë°¥/ìš´ë™/íœ´ì‹ Â· ìºë¦­í„°ëŠ” <b>ì‹­ì´ì§€</b>ë¡œ ì„ íƒ</div>
        </div>
        <div class="top-actions">
          <div class="pill"><span>ìºë¦­í„°</span> <strong id="zodiacName">ë¯¸ì„ íƒ</strong></div>
          <button class="btn primary" id="openPicker">ì‹­ì´ì§€ ì„ íƒ</button>
          <button class="btn" id="saveNow">ì €ì¥</button>
          <button class="btn danger" id="hardReset">ì´ˆê¸°í™”</button>
        </div>
      </div>

      <div class="screen-shell">
        <div class="screen" id="screen" aria-label="tamagotchi screen">
          <div class="bg">
            <div class="floor"></div>
            <div class="room-items">
              <div class="item" title="ì‹íƒ">ğŸ½ï¸</div>
              <div class="item" title="ì±…ì¥">ğŸ“š</div>
              <div class="item" title="ìš´ë™">ğŸƒâ€â™‚ï¸</div>
            </div>
          </div>

          <div class="hud">
            <div class="hud-left">
              <div class="hud-badge"><span>ì»¨ë””ì…˜</span> <strong id="moodText">ë³´í†µ</strong></div>
              <div class="hud-badge">
                <span>ë°°ê³ í””</span>
                <div class="bar" id="hungerBar"><i></i></div>
              </div>
            </div>
            <div class="hud-right">
              <div class="hud-badge"><span>ì—ë„ˆì§€</span> <div class="bar" id="energyBar"><i></i></div></div>
              <div class="hud-badge"><span>ìŠ¤íŠ¸ë¦­</span> <strong id="streakText">0</strong></div>
            </div>
          </div>

          <div class="character" id="char">
            <div class="bubble" id="bubble">...</div>
            <div class="sprite" id="sprite">â“</div>
            <div class="nameplate"><span id="nameplate">ìƒˆ ì¹œêµ¬ë¥¼ ì„ íƒí•´ì¤˜</span></div>
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="ctrl-left">
          <button class="btn primary" id="btnFeed">ğŸš ë°¥ ì£¼ê¸°</button>
          <button class="btn" id="btnExercise">ğŸ’ª ìš´ë™</button>
          <button class="btn" id="btnRest">ğŸ˜´ íœ´ì‹</button>
          <button class="btn" id="btnTalk">ğŸ’¬ ë§ê±¸ê¸°</button>
        </div>
        <div class="ctrl-right">
          <div class="hint">
            <b>ì´ë™:</b> ë°©í–¥í‚¤ / WASD<br/>
            <b>ë¹ ë¥¸í‚¤:</b> F(ë°¥) Â· E(ìš´ë™) Â· R(íœ´ì‹) Â· T(ëŒ€í™”)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Zodiac Picker Modal -->
  <div class="modal-backdrop" id="modal">
    <div class="modal" role="dialog" aria-modal="true" aria-label="ì‹­ì´ì§€ ì„ íƒ">
      <h3>ì‹­ì´ì§€ ìºë¦­í„° ì„ íƒ</h3>
      <p>ì¥, ì†Œ, í˜¸ë‘ì´, í† ë¼, ìš©, ë±€, ë§, ì–‘, ì›ìˆ­ì´, ë‹­, ê°œ, ë¼ì§€ ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒí•´.</p>
      <div class="zodiac-grid" id="zgrid"></div>
      <div class="modal-actions">
        <button class="btn" id="closePicker">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    /**********************
     * Minimal Tamagotchi Engine
     * - Single file (index.html)
     * - LocalStorage save
     * - Zodiac selection (12)
     * - Character moves in screen
     * - Feed/Exercise/Rest affects stats
     **********************/

    const STORAGE_KEY = "life_mogotchi_zodiac_v1";

    const ZODIAC = [
      { key:"rat",   name:"ì¥",   emoji:"ğŸ­" },
      { key:"ox",    name:"ì†Œ",   emoji:"ğŸ®" },
      { key:"tiger", name:"í˜¸ë‘ì´", emoji:"ğŸ¯" },
      { key:"rabbit",name:"í† ë¼", emoji:"ğŸ°" },
      { key:"dragon",name:"ìš©",  emoji:"ğŸ²" },
      { key:"snake", name:"ë±€",  emoji:"ğŸ" },
      { key:"horse", name:"ë§",  emoji:"ğŸ´" },
      { key:"goat",  name:"ì–‘",  emoji:"ğŸ‘" },
      { key:"monkey",name:"ì›ìˆ­ì´", emoji:"ğŸµ" },
      { key:"rooster",name:"ë‹­", emoji:"ğŸ”" },
      { key:"dog",   name:"ê°œ",  emoji:"ğŸ¶" },
      { key:"pig",   name:"ë¼ì§€", emoji:"ğŸ·" },
    ];

    const $ = (s)=>document.querySelector(s);
    const $$ = (s)=>Array.from(document.querySelectorAll(s));

    const ui = {
      screen: $("#screen"),
      char: $("#char"),
      sprite: $("#sprite"),
      bubble: $("#bubble"),
      nameplate: $("#nameplate"),
      zodiacName: $("#zodiacName"),
      moodText: $("#moodText"),
      hungerBar: $("#hungerBar"),
      energyBar: $("#energyBar"),
      streakText: $("#streakText"),
      modal: $("#modal"),
      zgrid: $("#zgrid"),
      openPicker: $("#openPicker"),
      closePicker: $("#closePicker"),
      saveNow: $("#saveNow"),
      hardReset: $("#hardReset"),
      btnFeed: $("#btnFeed"),
      btnExercise: $("#btnExercise"),
      btnRest: $("#btnRest"),
      btnTalk: $("#btnTalk"),
    };

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function now(){ return Date.now(); }
    function dayKey(ts = Date.now()){
      const d = new Date(ts);
      // local day key
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
    }

    function defaultState(){
      return {
        zodiacKey: "",
        // position in px relative to screen
        pos: { x: 0, y: 0 },
        // 0..100
        hunger: 55,  // higher = more full (less hungry)
        energy: 60,
        mood: 50,    // 0..100 (affects face text)
        streak: 0,
        lastActiveDay: "",
        lastSavedAt: 0,
        lastActionAt: 0,
        // small animation state
        dir: { x:0, y:0 },
      };
    }

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return defaultState();
        const s = JSON.parse(raw);

        // fill missing
        const base = defaultState();
        const merged = {
          ...base,
          ...s,
          pos: { ...base.pos, ...(s.pos||{}) },
          dir: { ...base.dir, ...(s.dir||{}) },
        };
        return merged;
      }catch(e){
        localStorage.removeItem(STORAGE_KEY);
        return defaultState();
      }
    }

    function saveState(){
      state.lastSavedAt = now();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    // Set initial char position to center if not set
    function ensurePosition(){
      const rect = ui.screen.getBoundingClientRect();
      const cw = 120, ch = 120;
      if(state.pos.x === 0 && state.pos.y === 0){
        state.pos.x = rect.width/2 - cw/2;
        state.pos.y = rect.height*0.58 - ch/2;
      }
      // bounds
      const pad = 8;
      state.pos.x = clamp(state.pos.x, pad, rect.width - cw - pad);
      state.pos.y = clamp(state.pos.y, 66, rect.height - ch - 10); // keep above bottom floor a bit
    }

    // Mood label
    function moodLabel(){
      const h = state.hunger;
      const e = state.energy;

      // Quick mood heuristics: hungry/low energy -> sad
      const score = (h*0.55 + e*0.45);
      if(score >= 72) return { text:"ì¢‹ìŒ", color:"var(--good)", face:"ğŸ™‚" };
      if(score >= 45) return { text:"ë³´í†µ", color:"var(--ok)", face:"ğŸ˜" };
      return { text:"í˜ë“¦", color:"var(--bad)", face:"ğŸ˜" };
    }

    function setBar(el, value){
      const v = clamp(value, 0, 100);
      const i = el.querySelector("i");
      i.style.width = `${v}%`;
      el.classList.toggle("warn", v < 55 && v >= 30);
      el.classList.toggle("bad", v < 30);
    }

    function zodiacByKey(key){
      return ZODIAC.find(z => z.key === key) || null;
    }

    function showBubble(msg){
      ui.bubble.textContent = msg;
      ui.bubble.classList.add("show");
      window.clearTimeout(showBubble._t);
      showBubble._t = window.setTimeout(()=> ui.bubble.classList.remove("show"), 1400);
    }

    function updateUI(){
      ensurePosition();

      // position
      ui.char.style.left = `${state.pos.x + 60}px`; // char is 120 wide, anchored center
      ui.char.style.top  = `${state.pos.y + 60}px`;

      // zodiac
      const z = zodiacByKey(state.zodiacKey);
      ui.sprite.textContent = z ? z.emoji : "â“";
      ui.zodiacName.textContent = z ? z.name : "ë¯¸ì„ íƒ";
      ui.nameplate.textContent = z ? `${z.name} Â· LIFE-MOGOTCHI` : "ìƒˆ ì¹œêµ¬ë¥¼ ì„ íƒí•´ì¤˜";

      // mood + bars
      const m = moodLabel();
      ui.moodText.textContent = m.text;
      ui.moodText.style.color = m.color;

      // hunger bar: show "fullness" value (higher better)
      setBar(ui.hungerBar, state.hunger);
      setBar(ui.energyBar, state.energy);

      ui.streakText.textContent = String(state.streak || 0);

      // subtle bob animation via transform based on movement
      const moving = Math.abs(state.dir.x) + Math.abs(state.dir.y) > 0.05;
      ui.sprite.style.transform = moving ? "translateY(-2px) scale(1.01)" : "translateY(0) scale(1)";
      ui.sprite.style.transition = "transform .10s";
    }

    // Daily decay + streak logic
    function applyDailyLogic(){
      const today = dayKey();
      if(!state.lastActiveDay){
        state.lastActiveDay = today;
        return;
      }
      if(state.lastActiveDay !== today){
        // If user was active yesterday, keep streak; else reset
        const last = new Date(state.lastActiveDay + "T00:00:00");
        const t = new Date(today + "T00:00:00");
        const diffDays = Math.round((t - last) / 86400000);

        if(diffDays === 1){
          state.streak = (state.streak || 0) + 1;
        }else{
          state.streak = 0;
        }

        // decay per missed day (diffDays)
        const d = Math.min(7, Math.max(1, diffDays));
        state.hunger = clamp(state.hunger - 10*d, 0, 100);
        state.energy = clamp(state.energy - 8*d, 0, 100);

        state.lastActiveDay = today;
        showBubble("ìƒˆë¡œìš´ í•˜ë£¨ì•¼. ë‹¤ì‹œ ëŒë´ì¤˜!");
      }
    }

    // Continuous decay over time (per minute-ish)
    function tickDecay(dtMs){
      // dt in ms
      const dt = dtMs / 1000;
      // drain rates per second (very slow)
      state.hunger = clamp(state.hunger - dt*0.03, 0, 100);
      state.energy = clamp(state.energy - dt*0.025, 0, 100);

      // mood nudges (not shown as number, but we keep a mood scalar)
      const target = (state.hunger*0.55 + state.energy*0.45);
      state.mood = clamp(state.mood + (target - state.mood)*0.02, 0, 100);
    }

    // Actions
    function canAct(){
      const z = zodiacByKey(state.zodiacKey);
      if(!z){
        showBubble("ë¨¼ì € ì‹­ì´ì§€ ìºë¦­í„°ë¥¼ ì„ íƒí•´ì¤˜!");
        openPicker();
        return false;
      }
      return true;
    }

    function actFeed(){
      if(!canAct()) return;
      state.hunger = clamp(state.hunger + 28, 0, 100);
      state.energy = clamp(state.energy + 6, 0, 100);
      state.lastActionAt = now();
      showBubble("ğŸš ëƒ ëƒ â€¦ ë“ ë“ í•´!");
      updateUI();
      saveState();
    }

    function actExercise(){
      if(!canAct()) return;
      // exercising costs energy, improves mood a bit and appetite (hunger decreases)
      state.energy = clamp(state.energy - 14, 0, 100);
      state.hunger = clamp(state.hunger - 10, 0, 100);
      state.mood = clamp(state.mood + 6, 0, 100);
      state.lastActionAt = now();
      showBubble("ğŸ’ª í›„â€¦ ìƒì¾Œí•´!");
      updateUI();
      saveState();
    }

    function actRest(){
      if(!canAct()) return;
      state.energy = clamp(state.energy + 26, 0, 100);
      // rest doesn't fill stomach; slightly decreases hunger (time passes)
      state.hunger = clamp(state.hunger - 4, 0, 100);
      state.lastActionAt = now();
      showBubble("ğŸ˜´ ì ê¹ ì‰¬ìâ€¦");
      updateUI();
      saveState();
    }

    function actTalk(){
      if(!canAct()) return;
      const m = moodLabel();
      const z = zodiacByKey(state.zodiacKey);
      const linesGood = [
        `ì˜¤ëŠ˜ë„ ì˜ ëŒë³´ê³  ìˆë„¤ ğŸ™‚`,
        `ì§€ê¸ˆì˜ ë„ˆ, ì¶©ë¶„íˆ ê´œì°®ì•„.`,
        `ë°¥ ì±™ê¸´ ê±° ìµœê³ ì•¼!`,
        `ì¡°ê¸‰í•´í•˜ì§€ ë§ì. ì²œì²œíˆ.`,
      ];
      const linesOk = [
        `í•œ ê°€ì§€ë§Œ í•´ë„ ì¶©ë¶„í•´.`,
        `ë¬¼ í•œ ì” + ë°¥ í•œ ë¼ê°€ ë¨¼ì €ì•¼.`,
        `ì§€ê¸ˆë„ ê³„ì† ë‚˜ì•„ê°€ëŠ” ì¤‘ì´ì•¼.`,
        `ì˜¤ëŠ˜ì€ â€œìœ ì§€â€ë§Œ í•´ë„ ì„±ê³µ.`,
      ];
      const linesBad = [
        `ë°°ê³ íŒŒâ€¦ ë°¥ ì¢€â€¦ ğŸ¥²`,
        `ì§€ì¹˜ë©´ ì‰¬ì–´ë„ ë¼.`,
        `ì˜¤ëŠ˜ì€ ìµœì†Œí•œì˜ ëŒë´„ë§Œ í•˜ì.`,
        `ë„ˆ ìì‹ ì„ ë„ˆë¬´ ëª°ì•„ë¶™ì´ì§€ ë§ˆ.`,
      ];
      const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
      const msg = (m.text==="ì¢‹ìŒ") ? pick(linesGood)
               : (m.text==="ë³´í†µ") ? pick(linesOk)
               : pick(linesBad);
      showBubble(`${z.name}: ${msg}`);
      state.lastActionAt = now();
      updateUI();
      saveState();
    }

    // Movement
    const keys = new Set();
    function onKeyDown(e){
      const k = e.key.toLowerCase();
      // prevent page scroll on arrows
      if(["arrowup","arrowdown","arrowleft","arrowright"].includes(e.key)) e.preventDefault();
      keys.add(k);

      // hotkeys
      if(k === "f") actFeed();
      if(k === "e") actExercise();
      if(k === "r") actRest();
      if(k === "t") actTalk();
    }
    function onKeyUp(e){
      keys.delete(e.key.toLowerCase());
    }

    function computeDir(){
      let dx = 0, dy = 0;
      if(keys.has("arrowleft") || keys.has("a")) dx -= 1;
      if(keys.has("arrowright")|| keys.has("d")) dx += 1;
      if(keys.has("arrowup")   || keys.has("w")) dy -= 1;
      if(keys.has("arrowdown") || keys.has("s")) dy += 1;

      // normalize diagonal
      if(dx !== 0 && dy !== 0){
        dx *= 0.7071;
        dy *= 0.7071;
      }
      state.dir.x = dx;
      state.dir.y = dy;
    }

    function move(dtMs){
      computeDir();
      const rect = ui.screen.getBoundingClientRect();
      const speed = 0.18; // px per ms
      const cw = 120, ch = 120;
      const pad = 8;

      // slow down if low energy
      const energyFactor = clamp(0.55 + (state.energy/100)*0.65, 0.55, 1.2);

      const vx = state.dir.x * speed * dtMs * energyFactor;
      const vy = state.dir.y * speed * dtMs * energyFactor;

      state.pos.x = clamp(state.pos.x + vx, pad, rect.width - cw - pad);
      state.pos.y = clamp(state.pos.y + vy, 66, rect.height - ch - 10);

      // if moving, tiny extra drain
      const moving = Math.abs(state.dir.x) + Math.abs(state.dir.y) > 0.05;
      if(moving){
        state.energy = clamp(state.energy - dtMs*0.002, 0, 100);
        state.hunger = clamp(state.hunger - dtMs*0.0015, 0, 100);
      }
    }

    // Zodiac Picker
    function buildZodiacGrid(){
      ui.zgrid.innerHTML = "";
      ZODIAC.forEach(z=>{
        const el = document.createElement("div");
        el.className = "zodiac";
        el.setAttribute("data-key", z.key);
        el.innerHTML = `<div class="e">${z.emoji}</div><div class="t">${z.name}</div>`;
        el.addEventListener("click", ()=>{
          state.zodiacKey = z.key;
          showBubble(`${z.name} ì„ íƒ ì™„ë£Œ!`);
          closePicker();
          updateUI();
          saveState();
        });
        ui.zgrid.appendChild(el);
      });
    }
    function openPicker(){
      ui.modal.classList.add("show");
    }
    function closePicker(){
      ui.modal.classList.remove("show");
    }

    // Buttons
    ui.openPicker.addEventListener("click", openPicker);
    ui.closePicker.addEventListener("click", closePicker);
    ui.modal.addEventListener("click", (e)=>{
      if(e.target === ui.modal) closePicker();
    });

    ui.btnFeed.addEventListener("click", actFeed);
    ui.btnExercise.addEventListener("click", actExercise);
    ui.btnRest.addEventListener("click", actRest);
    ui.btnTalk.addEventListener("click", actTalk);

    ui.saveNow.addEventListener("click", ()=>{
      saveState();
      showBubble("ì €ì¥í–ˆì–´!");
    });

    ui.hardReset.addEventListener("click", ()=>{
      if(!confirm("ì •ë§ ì´ˆê¸°í™”í• ê¹Œ? ìºë¦­í„°/ìƒíƒœ/ìŠ¤íŠ¸ë¦­ì´ ëª¨ë‘ ë¦¬ì…‹ë¼.")) return;
      localStorage.removeItem(STORAGE_KEY);
      state = loadState();
      ensurePosition();
      buildZodiacGrid();
      updateUI();
      showBubble("ì´ˆê¸°í™” ì™„ë£Œ!");
    });

    // Game loop
    let state = loadState();
    let lastTs = now();

    function loop(){
      const ts = now();
      const dt = ts - lastTs;
      lastTs = ts;

      // daily logic (once per loop is fine)
      applyDailyLogic();

      // decay
      tickDecay(dt);

      // movement
      move(dt);

      // occasional autosave
      if(ts - (state.lastSavedAt || 0) > 10000) saveState();

      // update ui
      updateUI();

      requestAnimationFrame(loop);
    }

    // Init
    buildZodiacGrid();
    ensurePosition();
    updateUI();

    // If zodiac not selected, open picker once
    if(!state.zodiacKey) {
      setTimeout(()=> openPicker(), 250);
      showBubble("ì‹­ì´ì§€ ìºë¦­í„°ë¥¼ ê³¨ë¼ì¤˜!");
    } else {
      showBubble("ë‹¤ì‹œ ì™”ë„¤ ğŸ™‚");
    }

    window.addEventListener("keydown", onKeyDown, { passive:false });
    window.addEventListener("keyup", onKeyUp);

    // keep bounds on resize
    window.addEventListener("resize", ()=>{
      ensurePosition();
      updateUI();
      saveState();
    });

    requestAnimationFrame(loop);
  </script>
</body>
</html>
